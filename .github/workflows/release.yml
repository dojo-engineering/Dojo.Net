name: Publish Nuget

on:
  release:
    types: [published]
  pull_request:
    branches:
      - main

jobs:
  build:
    env:
      BUILD_CONFIG: 'Release'
      PROJECT: 'Dojo.Net.csproj'

    runs-on: windows-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    defaults:
      run:
        working-directory: ./src

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}

    - name: Download and install Google Cloud KMS CNG Provider
      shell: pwsh
      working-directory: ${{ github.workspace }}
      run: |
        # Download KMS CNG Provider v1.3
        $version = "1.3"
        $downloadUrl = "https://github.com/GoogleCloudPlatform/kms-integrations/releases/download/cng-v$version/kmscng-$version-windows-amd64.zip"
        
        Write-Host "Downloading KMS CNG Provider v$version from $downloadUrl"
        Invoke-WebRequest -Uri $downloadUrl -OutFile "kmscng.zip"
        
        # Extract the ZIP
        Write-Host "Extracting KMS CNG Provider"
        Expand-Archive -Path "kmscng.zip" -DestinationPath "kmscng" -Force
        
        # List contents to debug
        Write-Host "Contents of kmscng directory:"
        Get-ChildItem -Path "kmscng" -Recurse
        
        # Install the MSI with full path
        $msiFile = Resolve-Path "kmscng\kmscng.msi"
        Write-Host "Installing KMS CNG Provider from $msiFile"
        
        $installArgs = @(
          '/i'
          $msiFile.Path
          '/quiet'
          '/norestart'
          '/l*v'
          'install.log'
        )
        
        $process = Start-Process msiexec.exe -ArgumentList $installArgs -Wait -NoNewWindow -PassThru
        
        if ($process.ExitCode -ne 0) {
          Write-Host "Installation failed with exit code: $($process.ExitCode)"
          if (Test-Path 'install.log') {
            Write-Host "Installation log:"
            Get-Content 'install.log' | Select-Object -Last 50
          }
          exit 1
        }
        
        Write-Host "KMS CNG Provider v$version installed successfully"

    - name: Configure KMS CNG Provider
      shell: pwsh
      run: |
        # Create the config directory
        $configDir = "C:\Windows\KMSCNG"
        New-Item -ItemType Directory -Force -Path $configDir | Out-Null
        
        # Create the config file
        $configContent = @"
        ---
        resources:
          - crypto_key_version: "projects/${{ secrets.GCP_PROJECT_ID }}/locations/europe-west2/keyRings/EVCodeSigningKeyRing/cryptoKeys/EVCodeSignDojo/cryptoKeyVersions/1"
        "@
        
        Set-Content -Path "$configDir\config.yaml" -Value $configContent
        Write-Host "Configuration file created at $configDir\config.yaml"
        Get-Content "$configDir\config.yaml"

    - name: Debug - List available certificates and keys
      shell: pwsh
      run: |
        Write-Host "=== Checking KMS CNG Provider Configuration ==="
        if (Test-Path "C:\Windows\KMSCNG\config.yaml") {
          Write-Host "Config file exists:"
          Get-Content "C:\Windows\KMSCNG\config.yaml"
        } else {
          Write-Host "WARNING: Config file not found!"
        }
        
        Write-Host "`n=== Listing Certificate Stores ==="
        Get-ChildItem Cert:\CurrentUser\My | Format-Table Subject, Thumbprint, NotAfter
        Get-ChildItem Cert:\LocalMachine\My | Format-Table Subject, Thumbprint, NotAfter
        
        Write-Host "`n=== Checking for Google Cloud KMS Provider ==="
        # Try to list keys using CNG provider
        certutil -csp "Google Cloud KMS Provider" -key
        
        Write-Host "`n=== Checking if our certificate thumbprint exists ==="
        $thumbprint = "90C591BF5D43D241871569B3A222A72DD76DFA8A"
        $cert = Get-ChildItem Cert:\CurrentUser\My\$thumbprint -ErrorAction SilentlyContinue
        if ($cert) {
          Write-Host "Found certificate in CurrentUser\My: $($cert.Subject)"
        } else {
          $cert = Get-ChildItem Cert:\LocalMachine\My\$thumbprint -ErrorAction SilentlyContinue
          if ($cert) {
            Write-Host "Found certificate in LocalMachine\My: $($cert.Subject)"
          } else {
            Write-Host "Certificate with thumbprint $thumbprint NOT FOUND in certificate stores"
          }
        }

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration $env:BUILD_CONFIG -p:Version=${{ github.event.release.tag_name || '0.0.1-test' }} --no-restore /maxcpucount:1

    - name: Run tests
      run: dotnet test /p:Configuration=$env:BUILD_CONFIG --no-restore --no-build --verbosity normal
        
    - name: Sign NuGet packages
      shell: pwsh
      run: |
        # Find SignTool from Windows SDK
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | 
                        Where-Object { $_.FullName -like "*\x64\*" } | 
                        Select-Object -First 1
        
        if (-not $signtoolPath) {
          Write-Error "Could not find signtool.exe"
          exit 1
        }
        
        Write-Host "Using SignTool from: $($signtoolPath.FullName)"
        
        $packages = Get-ChildItem -Recurse -Filter "*.nupkg" | Where-Object { $_.Name -notlike "*.symbols.nupkg" }
        foreach ($package in $packages) {
          Write-Host "Signing $($package.FullName)"
          & $signtoolPath.FullName sign /v /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 `
            /sha1 90C591BF5D43D241871569B3A222A72DD76DFA8A `
            /csp "Google Cloud KMS Provider" `
            /kc "projects/${{ secrets.GCP_PROJECT_ID }}/locations/europe-west2/keyRings/EVCodeSigningKeyRing/cryptoKeys/EVCodeSignDojo/cryptoKeyVersions/1" `
            $package.FullName
        }

    - name: Publish
      if: ${{ github.event_name == 'release' }}
      run: dotnet nuget push **/*.nupkg --source 'https://api.nuget.org/v3/index.json' --api-key ${{secrets.NUGET_API_KEY}} --skip-duplicate
