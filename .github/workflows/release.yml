name: Publish Nuget

on:
  release:
    types: [published]
  pull_request:
    branches:
      - main

jobs:
  build:
    env:
      BUILD_CONFIG: 'Release'
      PROJECT: 'Dojo.Net.csproj'

    runs-on: windows-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    defaults:
      run:
        working-directory: ./src

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}

    - name: Download and install Google Cloud KMS CNG Provider
      shell: pwsh
      run: |
        # Download KMS CNG Provider v1.3
        $version = "1.3"
        $downloadUrl = "https://github.com/GoogleCloudPlatform/kms-integrations/releases/download/cng-v$version/kmscng-$version-windows-amd64.zip"
        
        Write-Host "Downloading KMS CNG Provider v$version from $downloadUrl"
        Invoke-WebRequest -Uri $downloadUrl -OutFile "kmscng.zip"
        
        # Extract the ZIP
        Write-Host "Extracting KMS CNG Provider"
        Expand-Archive -Path "kmscng.zip" -DestinationPath "kmscng" -Force
        
        # Install the MSI
        $msiFile = "kmscng\kmscng.msi"
        Write-Host "Installing KMS CNG Provider from $msiFile"
        Start-Process msiexec.exe -ArgumentList '/i', $msiFile, '/quiet', '/norestart' -Wait -NoNewWindow
        
        Write-Host "KMS CNG Provider v$version installed successfully"

    - name: Configure KMS CNG Provider
      shell: pwsh
      run: |
        # Create the config directory
        $configDir = "C:\Windows\KMSCNG"
        New-Item -ItemType Directory -Force -Path $configDir | Out-Null
        
        # Create the config file
        $configContent = @"
        ---
        resources:
          - crypto_key_version: "projects/${{ secrets.GCP_PROJECT_ID }}/locations/europe-west2/keyRings/EVCodeSigningKeyRing/cryptoKeys/EVCodeSignDojo/cryptoKeyVersions/1"
        "@
        
        Set-Content -Path "$configDir\config.yaml" -Value $configContent
        Write-Host "Configuration file created at $configDir\config.yaml"
        Get-Content "$configDir\config.yaml"

    - name: Build
      run: dotnet build --configuration $env:BUILD_CONFIG -p:Version=${{ github.event.release.tag_name || '0.0.1-test' }} --no-restore /maxcpucount:1

    - name: Run tests
      run: dotnet test /p:Configuration=$env:BUILD_CONFIG --no-restore --no-build --verbosity normal
        
    - name: Sign NuGet packages
      shell: pwsh
      run: |
        $packages = Get-ChildItem -Recurse -Filter "*.nupkg" | Where-Object { $_.Name -notlike "*.symbols.nupkg" }
        foreach ($package in $packages) {
          Write-Host "Signing $($package.FullName)"
          & signtool sign /v /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 `
            /sha1 90C591BF5D43D241871569B3A222A72DD76DFA8A `
            /csp "Google Cloud KMS Provider" `
            /kc "projects/${{ secrets.GCP_PROJECT_ID }}/locations/europe-west2/keyRings/EVCodeSigningKeyRing/cryptoKeys/EVCodeSignDojo/cryptoKeyVersions/1" `
            $package.FullName
        }

    - name: Publish
      if: ${{ github.event_name == 'release' }}
      run: dotnet nuget push **/*.nupkg --source 'https://api.nuget.org/v3/index.json' --api-key ${{secrets.NUGET_API_KEY}} --skip-duplicate
